<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¨˜å¸³ç³»çµ±</title>
  <style>
    :root{
      color-scheme: light;
      --bg:#f7f8fb; --fg:#1f2937; --muted:#6b7280; --card:#ffffff;
      --border:#e5e7eb; --border-strong:#d1d5db; --thead:#f3f4f6;
      --accent:#2563eb; --accent-2:#3b82f6; --shadow:0 8px 20px rgba(17,24,39,.08);
    }
    *, *::before, *::after { box-sizing: border-box; }
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans TC','PingFang TC','Microsoft JhengHei',sans-serif;
      line-height:1.55;
    }
    a{ color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    .container{ max-width:1200px; margin:24px auto 40px; padding:0 16px; }
    .appbar{ display:flex; align-items:center; gap:12px; margin-bottom:16px; flex-wrap:wrap; }
    .logo{ font-size:20px; font-weight:800; color:var(--accent); }
    .spacer{ flex:1; min-width:12px; }
    .nav{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .chip{
      display:inline-flex; align-items:center; padding:8px 12px;
      border:1px solid var(--border); border-radius:10px; background:#fff;
      color:var(--fg); text-decoration:none; transition:.15s ease; cursor:pointer;
    }
    .chip:hover{ background:#f9fafb; transform:translateY(-1px); }
    .meta-input{ height:36px; padding:0 10px; border:1px solid var(--border-strong); border-radius:8px; background:#fff; }
    .meta-label{ font-size:12px; color:var(--muted); margin:0 4px; }
    .card{ background:var(--card); border:1px solid var(--border);
      border-radius:16px; box-shadow:var(--shadow); overflow:hidden; }
    .card-header{ padding:16px 18px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px; }
    .card-title{ font-weight:800; }
    .month-nav{ display:flex; align-items:center; gap:8px; }
    .month-label{ font-weight:700; color:var(--fg); min-width:9ch; text-align:center; }
    .card-body{ padding:20px 24px; }
    .toolbar{
      display:grid;
      grid-template-columns:minmax(160px,200px) minmax(280px,1fr) minmax(140px,200px) 110px;
      gap:14px; align-items:center; margin-bottom:10px;
    }
    .pair{ display:grid; grid-template-columns:max-content 1fr; column-gap:10px; align-items:center; min-width:0; }
    .label-inline{ white-space:nowrap; font-size:14px; color:var(--muted); padding-right:2px; line-height:1.2; }
    .input{
      display:block; width:100%; height:44px; padding:0 14px;
      border:1px solid var(--border-strong); background:#fff; color:#111827;
      border-radius:12px; outline:none; transition:.15s ease;
      box-shadow:inset 0 1px 0 rgba(0,0,0,.02); min-width:0;
    }
    .input::placeholder{ color:#94a3b8; }
    .input:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,.2); }
    input[type=number]{ appearance:textfield; -moz-appearance:textfield; }
    .btn{
      height:44px; padding:0 18px; border-radius:12px; border:1px solid rgba(37,99,235,.55);
      background:linear-gradient(180deg,var(--accent-2),var(--accent));
      color:#fff; font-weight:700; letter-spacing:.3px; cursor:pointer;
      transition:.15s ease; box-shadow:0 8px 16px rgba(37,99,235,.18);
    }
    .btn:hover{ filter:brightness(1.05); transform:translateY(-1px); }
    table{ width:100%; border-collapse:collapse; background:#fff; }
    thead th{ background:var(--thead); position:sticky; top:0; }
    th,td{ border-top:1px solid var(--border); padding:12px; text-align:left; vertical-align:middle; }
    tbody tr:hover{ background:#f9fafb; }
    .right{ text-align:right; }
    .cell{
      width:100%; border:none; outline:none; background:transparent; padding:6px 0;
      border-bottom:2px solid transparent; transition:.12s ease;
    }
    .cell:focus{ border-bottom-color:var(--accent); }
    tfoot td{ background:#fafafa; font-weight:800; }
    .icon-btn{ border:1px solid var(--border-strong); background:#fff; color:var(--fg); border-radius:10px; padding:6px 10px; cursor:pointer; transition:.15s ease; }
    .icon-btn:hover{ background:#f3f4f6; transform:translateY(-1px); }
  </style>
</head>
<body>
  <div class="container">
    <header class="appbar">
      <div class="logo">ğŸ“’ è¨˜å¸³ç³»çµ±</div>
      <div class="spacer"></div>
      <nav class="nav">
        <span class="meta-label">å‡ºè²¨å» å•†</span>
        <input id="meta-vendor" class="meta-input" type="text" placeholder="å¯ç•™ç©º" value="{{ vendor }}">
        <span class="meta-label">å‡ºè²¨æ—¥æœŸ</span>
        <input id="meta-date" class="meta-input" type="date" value="{{ date }}">
        <a class="chip" id="btn-new-file">ğŸ“„ æ–°å¢æª”æ¡ˆ</a>
        <a class="chip" id="btn-open-file">ğŸ“‚ é–‹å•Ÿæª”æ¡ˆ</a>
        <a class="chip" href="{{ url_for('products_page') }}">ğŸ“‹ ç”¢å“æ¸…å–®</a>
      </nav>
    </header>

    <section class="card">
      <div class="card-header">
        <div class="card-title">æ–°å¢ä¸€ç­†è¨˜éŒ„</div>
        <div class="month-nav"><div class="month-label">{{ date }}</div></div>
      </div>

      <div class="card-body">
        <form method="POST" class="toolbar" novalidate onsubmit="return false;">
          <div class="pair">
            <label for="product-id" class="label-inline">ç·¨è™Ÿ</label>
            <input id="product-id" class="input" type="number" placeholder="è¼¸å…¥ç”¢å“ç·¨è™Ÿ" required inputmode="numeric"
                   value="{{ request.args.get('product_id','') }}">
          </div>
          <div class="pair">
            <label for="product-name" class="label-inline">ç”¢å“åç¨±</label>
            <input id="product-name" class="input" type="text" readonly placeholder="è‡ªå‹•é¡¯ç¤ºç”¢å“åç¨±">
          </div>
          <div class="pair">
            <label for="quantity" class="label-inline">æ•¸é‡</label>
            <input id="quantity" class="input" type="text" placeholder="ä¾‹å¦‚ï¼š20æ–¤ã€1å…¬æ–¤ã€5å€‹" required>
          </div>
          <button class="btn" id="btn-add" type="button">æ–°å¢</button>
        </form>
      </div>

      <table id="grid">
        <thead>
          <tr>
            <th>ç·¨è™Ÿ</th><th>ç”¢å“</th><th>æ•¸é‡</th><th>å–®ä½</th>
            <th class="right">å–®åƒ¹</th><th class="right">ç¸½è¨ˆ</th><th class="right">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          {% for row in rows %}
          <tr data-index="{{ loop.index0 }}">
            <td><input class="cell" type="number" value="{{ row[0] }}" data-field="ç·¨è™Ÿ"></td>
            <td>{{ row[1] }}</td>
            <td><input class="cell right" type="text" value="{{ row[2] }}" data-field="æ•¸é‡"></td>
            <td>{{ row[3] }}</td>
            <td class="right">{{ row[4] }}</td>
            <td class="right">{{ row[5] }}</td>
            <td class="right"><button class="icon-btn btn-del" type="button">ğŸ—‘ åˆªé™¤</button></td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot><tr><td colspan="6" class="right">ç¸½é‡‘é¡</td><td class="right" id="total-sum">{{ total_sum }}</td></tr></tfoot>
      </table>
    </section>
  </div>

  <script>
  (function(){
    const grid=document.getElementById('grid');
    const totalEl=document.getElementById('total-sum');
    const vendorEl=document.getElementById('meta-vendor');
    const dateEl=document.getElementById('meta-date');
    const pidEl=document.getElementById('product-id');
    const pnameEl=document.getElementById('product-name');
    const qtyEl=document.getElementById('quantity');
    const url=new URL(location.href);
    const currentFile=url.searchParams.get('file')||'';

    // ğŸ’¾ è¨˜éŒ„ç›®å‰æª”æ¡ˆåƒæ•¸ï¼Œä¾›ç”¢å“æ¸…å–®è¿”å›ä½¿ç”¨
    (function(){
      const params = new URLSearchParams(window.location.search);
      sessionStorage.setItem('current_order_params', params.toString());
    })();

    // ç”¢å“åç¨±è‡ªå‹•å¸¶å‡º
    async function fetchProduct(pid){
      if(!pid){ pnameEl.value=''; return; }
      try{
        const r=await fetch(`/api/products?query=${encodeURIComponent(pid)}`);
        const list=await r.json();
        pnameEl.value=(Array.isArray(list)&&list.length>0)?(list[0].name||''):'';
      }catch{ pnameEl.value=''; }
    }
    let t=null;
    const debounce=(fn,ms)=>function(...args){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args),ms); };
    pidEl.addEventListener('input',debounce(function(){ fetchProduct(this.value.trim()); },300));

    (function(){
      const initPid=(pidEl.value||'').trim();
      if(initPid) fetchProduct(initPid);
    })();

    async function addRow(){
      const payload={date:(dateEl.value||'').trim(),vendor:(vendorEl.value||'').trim(),filename:currentFile,product_id:(pidEl.value||'').trim(),quantity:(qtyEl.value||'').trim()};
      if(!payload.date||!payload.product_id||!payload.quantity) return alert('è«‹å®Œæ•´è¼¸å…¥æ—¥æœŸã€ç·¨è™Ÿã€æ•¸é‡');
      const r=await fetch('/api_add_row',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const j=await r.json(); if(!j.ok) return alert(j.error||'æ–°å¢å¤±æ•—');
      location.reload();
    }
    document.getElementById('btn-add').addEventListener('click',addRow);
    [pidEl,qtyEl].forEach(el=>el.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); addRow(); } }));

    grid.addEventListener('click',async(e)=>{
      const btn=e.target.closest('.btn-del'); if(!btn) return;
      const tr=btn.closest('tr'); const idx=Number(tr.dataset.index);
      if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç­†è³‡æ–™ï¼Ÿ')) return;
      const payload={date:(dateEl.value||'').trim(),vendor:(vendorEl.value||'').trim(),filename:currentFile,row_index:idx};
      const r=await fetch('/api_delete_row',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const j=await r.json(); if(!j.ok) return alert(j.error||'åˆªé™¤å¤±æ•—');
      location.reload();
    });

    document.getElementById('btn-new-file').addEventListener('click',async()=>{
      const d=(dateEl.value||'').trim();
      const r=await fetch('/api/orders/new',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({date:d})});
      const j=await r.json(); if(!j.ok) return alert('å»ºç«‹æ–°æª”å¤±æ•—');
      location.search=`?date=${encodeURIComponent(d)}&vendor=&file=${encodeURIComponent(j.filename)}`;
    });

    document.getElementById('btn-open-file').addEventListener('click',async()=>{
      const d=(dateEl.value||'').trim(); const ym=d?d.slice(0,7):'';
      const r=await fetch(`/api/orders/list?ym=${encodeURIComponent(ym)}`);
      const arr=await r.json(); if(!arr.length) return alert(`${ym||'é¸å®šæœˆä»½'} æ²’æœ‰æª”æ¡ˆ`);
      const pick=prompt(arr.map((x,i)=>`${i+1}. ${x.display}`).join('\n'));
      const n=Number(pick); if(!n||n<1||n>arr.length) return;
      const it=arr[n-1]; let v=''; const m=it.filename.match(/^\d{4}-\d{2}-\d{2}__(.+)\.csv$/); if(m) v=m[1];
      location.search=`?date=${encodeURIComponent(d)}&vendor=${encodeURIComponent(v)}&file=${encodeURIComponent(it.filename)}`;
    });

    vendorEl.addEventListener('change',async()=>{
      const v=vendorEl.value.trim(); const d=dateEl.value.trim();
      if(!v||!d) return; if(!currentFile.startsWith('newfile_')) return;
      const r=await fetch('/api/orders/rename',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({date:d,new_vendor:v,filename:currentFile})});
      const j=await r.json(); if(!j.ok) return alert(j.error||'æ”¹åå¤±æ•—');
      location.search=`?date=${encodeURIComponent(d)}&vendor=${encodeURIComponent(v)}&file=${encodeURIComponent(j.new_name)}`;
    });
  })();
  </script>
</body>
</html>
