<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¨˜å¸³ç³»çµ±</title>

  <style>
    :root{
      color-scheme: light;
      --bg:#f7f8fb; --fg:#1f2937; --muted:#6b7280; --card:#ffffff;
      --border:#e5e7eb; --border-strong:#d1d5db; --thead:#f3f4f6;
      --accent:#2563eb; --accent-2:#3b82f6; --shadow:0 8px 20px rgba(17,24,39,.08);
    }
    *, *::before, *::after { box-sizing: border-box; }
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans TC','PingFang TC','Microsoft JhengHei',sans-serif;
      line-height:1.55;
    }
    a{ color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .container{ max-width:1200px; margin:24px auto 40px; padding:0 16px; }

    .appbar{ display:flex; align-items:center; gap:12px; margin-bottom:16px; flex-wrap:wrap; }
    .logo{ font-size:20px; font-weight:800; color:var(--accent); }
    .spacer{ flex:1; min-width:12px; }

    .nav{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .chip{
      display:inline-flex; align-items:center; padding:8px 12px;
      border:1px solid var(--border); border-radius:10px; background:#fff;
      color:var(--fg); cursor:pointer; transition:.15s ease;
    }
    .chip:hover{ background:#f9fafb; transform:translateY(-1px); }

    .meta-input{ height:36px; padding:0 10px; border:1px solid var(--border-strong); border-radius:8px; background:#fff; }
    .meta-label{ font-size:12px; color:var(--muted); margin:0 4px; }

    .card{ background:var(--card); border:1px solid var(--border);
      border-radius:16px; box-shadow:var(--shadow); overflow:hidden; }
    .card-header{ padding:16px 18px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; }
    .card-title{ font-weight:800; }
    .month-nav{ display:flex; align-items:center; }
    .month-label{ font-weight:700; color:var(--fg); min-width:9ch; text-align:center; }

    .card-body{ padding:20px 24px; }
    .toolbar{
      display:grid;
      grid-template-columns:minmax(120px,160px) minmax(200px,1fr) minmax(100px,160px) 100px;
      gap:16px; align-items:center;
    }
    .pair{ display:grid; grid-template-columns:max-content 1fr; align-items:center; gap:10px; }

    .input{
      display:block; width:100%; height:44px; padding:0 14px;
      border:1px solid var(--border-strong); background:#fff; color:#111827;
      border-radius:12px; outline:none; transition:.15s ease;
      box-shadow:inset 0 1px 0 rgba(0,0,0,.02);
    }
    .right{ text-align:right; }

    table{ width:100%; border-collapse:collapse; background:#fff; }
    thead th{ background:var(--thead); }
    th,td{ border-top:1px solid var(--border); padding:12px; }

    /* ç·¨è™Ÿã€ç”¢å“ â†’ å·¦å°é½Š */
    #grid thead th:nth-child(1),
    #grid tbody td:nth-child(1),
    #grid thead th:nth-child(2),
    #grid tbody td:nth-child(2){
      text-align:left;
    }

    /* æ•¸é‡ã€å–®ä½ã€å–®åƒ¹ã€ç¸½è¨ˆã€æ“ä½œ â†’ å³å°é½Š */
    #grid thead th:nth-child(3),
    #grid tbody td:nth-child(3),
    #grid thead th:nth-child(4),
    #grid tbody td:nth-child(4),
    #grid thead th:nth-child(5),
    #grid tbody td:nth-child(5),
    #grid thead th:nth-child(6),
    #grid tbody td:nth-child(6),
    #grid thead th:nth-child(7),
    #grid tbody td:nth-child(7){
      text-align:right;
    }

    /* æ•¸é‡ input å³å°é½Š */
    .cell.right{ text-align:right !important; }

    .cell{
      width:100%; border:none; outline:none; background:transparent;
      padding:6px 0; border-bottom:2px solid transparent; transition:.12s ease;
    }
    .cell:focus{ border-bottom-color:var(--accent); }

    tfoot td{ background:#fafafa; font-weight:800; text-align:right; }

    .icon-btn{
      border:1px solid var(--border-strong); background:#fff;
      border-radius:10px; padding:6px 10px; cursor:pointer;
    }
    .btn{
      height:44px; padding:0 18px; border-radius:12px;
      background:linear-gradient(180deg,var(--accent-2),var(--accent));
      border:1px solid rgba(37,99,235,.55);
      color:#fff; font-weight:700; cursor:pointer;
    }
  </style>
</head>

<body>
  <div class="container">

    <header class="appbar">
      <div class="logo">ğŸ“’ è¨˜å¸³ç³»çµ±</div>
      <div class="spacer"></div>

      <nav class="nav">
        <span class="meta-label">å‡ºè²¨å» å•†</span>
        <input id="meta-vendor" class="meta-input" type="text" placeholder="å¯ç•™ç©º" value="{{ vendor }}">

        <span class="meta-label">å‡ºè²¨æ—¥æœŸ</span>
        <input id="meta-date" class="meta-input" type="date" value="{{ date }}">

        <a class="chip" id="btn-new-file">ğŸ“„ æ–°å¢æª”æ¡ˆ</a>
        <a class="chip" id="btn-open-file">ğŸ“‚ é–‹å•Ÿæª”æ¡ˆ</a>
        <a class="chip" href="{{ url_for('products_page') }}">ğŸ“‹ ç”¢å“æ¸…å–®</a>
        <a class="chip" id="btn-preview">ğŸ” é è¦½åˆ—å°</a>
      </nav>
    </header>

    <section class="card">

      <div class="card-header">
        <div class="card-title">æ–°å¢ä¸€ç­†è¨˜éŒ„</div>

        <!-- æª”æ¡ˆæ—¥æœŸï¼šå„ªå…ˆç”¨ file_date -->
        <div class="month-nav">
          <div class="month-label">{{ file_date or date }}</div>
        </div>
      </div>

      <div class="card-body">

        <!-- ç”¨ hidden æŠŠæª”æ¡ˆæ—¥æœŸä¸Ÿçµ¦å‰ç«¯ JS -->
        <input type="hidden" id="file-date" value="{{ file_date or '' }}">

        <form class="toolbar" onsubmit="return false;">
          <div class="pair">
            <label>ç·¨è™Ÿ</label>
            <input id="product-id" class="input" type="number" placeholder="è¼¸å…¥ç”¢å“ç·¨è™Ÿ">
          </div>

          <div class="pair">
            <label>ç”¢å“åç¨±</label>
            <input id="product-name" class="input" type="text" placeholder="è‡ªå‹•é¡¯ç¤ºç”¢å“åç¨±" readonly>
          </div>

          <div class="pair">
            <label>æ•¸é‡</label>
            <input id="quantity" class="input right" type="text" placeholder="ä¾‹å¦‚ï¼š20æ–¤ã€1å…¬æ–¤ã€5å€‹">
          </div>

          <button class="btn" id="btn-add" type="button">æ–°å¢</button>
        </form>

      </div>

      <table id="grid">
        <thead>
          <tr>
            <th>ç·¨è™Ÿ</th>
            <th>ç”¢å“</th>
            <th>æ•¸é‡</th>
            <th>å–®ä½</th>
            <th>å–®åƒ¹</th>
            <th>ç¸½è¨ˆ</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>

        <tbody>
          {% for row in rows %}
          <tr data-index="{{ loop.index0 }}">
            <td><input class="cell" type="number" value="{{ row[0] }}" data-field="ç·¨è™Ÿ"></td>
            <td>{{ row[1] }}</td>
            <td><input class="cell right" type="text" value="{{ row[2] }}" data-field="æ•¸é‡"></td>
            <td>{{ row[3] }}</td>
            <td>{{ row[4] }}</td>
            <td>{{ row[5] }}</td>
            <td><button class="icon-btn btn-del">åˆªé™¤</button></td>
          </tr>
          {% endfor %}
        </tbody>

        <tfoot>
          <tr>
            <td colspan="6">ç¸½é‡‘é¡</td>
            <td id="total-sum">{{ total_sum }}</td>
          </tr>
        </tfoot>
      </table>

    </section>
  </div>

  <script>
  (function(){
    const grid      = document.getElementById('grid');
    const totalEl   = document.getElementById('total-sum');
    const vendorEl  = document.getElementById('meta-vendor');
    const dateEl    = document.getElementById('meta-date');
    const pidEl     = document.getElementById('product-id');
    const pnameEl   = document.getElementById('product-name');
    const qtyEl     = document.getElementById('quantity');
    const fileDateEl = document.getElementById('file-date');

    const url        = new URL(location.href);
    const currentFile = url.searchParams.get('file') || '';

    // è¨˜éŒ„ç›®å‰æª”æ¡ˆåƒæ•¸ï¼Œä¾›ç”¢å“æ¸…å–®è¿”å›ä½¿ç”¨
    (function(){
      const params = new URLSearchParams(window.location.search);
      sessionStorage.setItem('current_order_params', params.toString());
    })();

    // å–å¾—ç”¢å“åç¨±
    async function fetchProduct(pid){
      if(!pid){ pnameEl.value=''; return; }
      try{
        const r    = await fetch(`/api/products?query=${encodeURIComponent(pid)}`);
        const list = await r.json();
        pnameEl.value = (Array.isArray(list) && list.length > 0) ? (list[0].name || '') : '';
      }catch(e){
        pnameEl.value = '';
      }
    }

    let t = null;
    const debounce = (fn,ms)=>function(...args){
      clearTimeout(t);
      t = setTimeout(()=>fn.apply(this,args),ms);
    };

    pidEl.addEventListener('input', debounce(function(){
      fetchProduct(this.value.trim());
    }, 300));

    // æ–°å¢ä¸€ç­†
    async function addRow(){
      const payload = {
        date:     (dateEl.value    || '').trim(),
        vendor:   (vendorEl.value  || '').trim(),
        filename: currentFile,
        product_id: (pidEl.value   || '').trim(),
        quantity:   (qtyEl.value   || '').trim()
      };

      if(!payload.date || !payload.product_id || !payload.quantity){
        alert('è«‹å®Œæ•´è¼¸å…¥æ—¥æœŸã€ç·¨è™Ÿã€æ•¸é‡');
        return;
      }

      const r = await fetch('/api_add_row',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });
      const j = await r.json();
      if(!j.ok){
        alert(j.error || 'æ–°å¢å¤±æ•—');
        return;
      }
      location.reload();
    }

    document.getElementById('btn-add').addEventListener('click', addRow);
    [pidEl, qtyEl].forEach(el=>{
      el.addEventListener('keydown', e=>{
        if(e.key === 'Enter'){
          e.preventDefault();
          addRow();
        }
      });
    });

    // åˆªé™¤
    grid.addEventListener('click', async (e)=>{
      const btn = e.target.closest('.btn-del');
      if(!btn) return;
      const tr  = btn.closest('tr');
      const idx = Number(tr.dataset.index);

      if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç­†è³‡æ–™ï¼Ÿ')) return;

      const payload = {
        date:     (dateEl.value   || '').trim(),
        vendor:   (vendorEl.value || '').trim(),
        filename: currentFile,
        row_index: idx
      };

      const r = await fetch('/api_delete_row',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });
      const j = await r.json();
      if(!j.ok){
        alert(j.error || 'åˆªé™¤å¤±æ•—');
        return;
      }
      location.reload();
    });

    // âœ… è¡¨æ ¼å…§ç›´æ¥æ”¹ã€Œç·¨è™Ÿ / æ•¸é‡ã€å°±å­˜æª”
    grid.addEventListener('change', async (e)=>{
      const input = e.target.closest('.cell');
      if(!input) return;

      const tr    = input.closest('tr');
      const idx   = Number(tr.dataset.index);
      const field = input.dataset.field;   // ç·¨è™Ÿ / æ•¸é‡
      const value = input.value.trim();

      if(!field) return;

      const payload = {
        date:     (dateEl.value   || '').trim(),
        vendor:   (vendorEl.value || '').trim(),
        filename: currentFile,
        row_index: idx,
        field: field,
        value: value
      };

      const r = await fetch('/api_update_cell',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });
      const j = await r.json();
      if(!j.ok){
        alert(j.error || 'æ›´æ–°å¤±æ•—');
        return;
      }

      // æ›´æ–°è©²åˆ—é¡¯ç¤º
      const row = j.row; // [ç·¨è™Ÿ, ç”¢å“, æ•¸é‡, å–®ä½, å–®åƒ¹, ç¸½è¨ˆ]
      tr.querySelector('input[data-field="ç·¨è™Ÿ"]').value  = row[0];
      tr.querySelector('input[data-field="æ•¸é‡"]').value  = row[2];
      tr.children[3].textContent = row[3]; // å–®ä½
      tr.children[4].textContent = row[4]; // å–®åƒ¹
      tr.children[5].textContent = row[5]; // ç¸½è¨ˆ
      totalEl.textContent        = j.total_sum;
    });

    // æ–°å¢æª”æ¡ˆ
    document.getElementById('btn-new-file').addEventListener('click', async ()=>{
      const d = (dateEl.value || '').trim();
      const r = await fetch('/api/orders/new',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({date:d})
      });
      const j = await r.json();
      if(!j.ok){
        alert(j.error || 'å»ºç«‹æ–°æª”å¤±æ•—');
        return;
      }
      location.search = `?date=${encodeURIComponent(d)}&vendor=&file=${encodeURIComponent(j.filename)}`;
    });

    // é–‹å•Ÿæª”æ¡ˆï¼šdate æ”¹ç”¨æª”åçš„æ—¥æœŸ
    document.getElementById('btn-open-file').addEventListener('click', async ()=>{
      const d  = (dateEl.value || '').trim();
      const ym = d ? d.slice(0,7) : '';
      const r  = await fetch(`/api/orders/list?ym=${encodeURIComponent(ym)}`);
      const arr = await r.json();
      if(!arr.length){
        alert(`${ym || 'é¸å®šæœˆä»½'} æ²’æœ‰æª”æ¡ˆ`);
        return;
      }
      const pick = prompt(arr.map((x,i)=>`${i+1}. ${x.display}`).join('\n'));
      const n    = Number(pick);
      if(!n || n < 1 || n > arr.length) return;

      const it = arr[n-1];
      // å¾æª”åå–å‡ºæ—¥æœŸèˆ‡å» å•†
      const fileDate = it.filename.slice(0,10);
      let v = '';
      const m = it.filename.match(/^\d{4}-\d{2}-\d{2}__(.+)\.csv$/);
      if(m) v = m[1];

      location.search =
        `?date=${encodeURIComponent(fileDate)}&vendor=${encodeURIComponent(v)}&file=${encodeURIComponent(it.filename)}`;
    });

    // é‡æ–°å‘½åæª”æ¡ˆï¼ˆåªåœ¨ newfile_* æ™‚ç”Ÿæ•ˆï¼‰
    vendorEl.addEventListener('change', async ()=>{
      const v = vendorEl.value.trim();
      const d = dateEl.value.trim();
      if(!v || !d) return;
      if(!currentFile.startsWith('newfile_')) return;

      const r = await fetch('/api/orders/rename',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({date:d,new_vendor:v,filename:currentFile})
      });
      const j = await r.json();
      if(!j.ok){
        alert(j.error || 'æ”¹åå¤±æ•—');
        return;
      }
      location.search =
        `?date=${encodeURIComponent(d)}&vendor=${encodeURIComponent(v)}&file=${encodeURIComponent(j.new_name)}`;
    });

    // âœ… é è¦½åˆ—å°ï¼šç”¨æª”æ¡ˆæ—¥æœŸå„ªå…ˆï¼Œå…¶æ¬¡è¼¸å…¥æ¡†æ—¥æœŸ
    document.getElementById('btn-preview').addEventListener('click', ()=>{
      const fd = (fileDateEl.value || '').trim();
      const d  = (dateEl.value     || '').trim();
      const shipDate = fd || d;
      const v  = (vendorEl.value   || '').trim();

      if(!currentFile){
        alert('ç›®å‰æ²’æœ‰æª”æ¡ˆå¯é è¦½ï¼Œè«‹å…ˆæ–°å¢æˆ–é–‹å•Ÿæª”æ¡ˆã€‚');
        return;
      }

      const link = `/print_preview?date=${encodeURIComponent(shipDate)}&vendor=${encodeURIComponent(v)}&file=${encodeURIComponent(currentFile)}`;
      window.location.href = link;
    });

  })();
  </script>

</body>
</html>
